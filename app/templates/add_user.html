{% extends 'base.html' %}

{% block title %}Add User - Secure Uploader{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h3 class="card-title mb-3">Add New User</h3>

        <div id="message" style="display:none;" class="alert" role="alert"></div>

        <form id="addUserForm" onsubmit="return false;">
          <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">

          <div class="mb-3">
            <label class="form-label" for="username">Username</label>
            <input class="form-control" type="text" id="username" required>
          </div>

          <div class="mb-3">
            <label class="form-label" for="password">Password</label>
            <input class="form-control" type="password" id="password" required>
          </div>

          <div class="mb-3">
            <label class="form-label" for="role">Role</label>
            <select class="form-select" id="role">
              {% for role in roles %}
              <option value="{{ role }}">{{ role }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Add User</button>
            <a class="btn btn-secondary" href="{{ url_for('index') }}">Back to Home</a>
          </div>

        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const form = document.getElementById('addUserForm');
    const csrfToken = document.querySelector('input[name="_csrf"]').value;

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        fetch('/users', {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": csrfToken
            },
            body: JSON.stringify({
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            })
        })
        .then(res => res.json())
        .then(data => {
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';

            if (data.error) {
                messageDiv.className = 'alert alert-danger';
                messageDiv.textContent = data.error;
            } else {
                messageDiv.className = 'alert alert-success';
                messageDiv.textContent = 'User created successfully.';
                form.reset();
            }
        });

    });

});
</script>
{% endblock %}
