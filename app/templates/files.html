{% extends "base.html" %}

{% block title %}Files - Secure Uploader{% endblock %}

{% block content %}

<div class="container mt-4">

  <!-- STATUS BAR -->
  <div class="row mb-4">
    <div class="col-md-6">
      {% if USE_AZURE_BLOBS %}
        <div class="alert alert-success mb-2">
          <strong><i class="bi bi-cloud-check-fill"></i> Azure Blob Storage Active</strong>
        </div>
      {% else %}
        <div class="alert alert-secondary mb-2">
          <strong><i class="bi bi-hdd-fill"></i> Local Storage Mode</strong>
        </div>
      {% endif %}
    </div>

    <div class="col-md-6 text-end">
      {% if ENCRYPTION_AVAILABLE %}
        <div class="alert alert-primary mb-2">
          <strong><i class="bi bi-lock-fill"></i> Encryption Enabled</strong>
        </div>
      {% else %}
        <div class="alert alert-warning mb-2">
          <strong><i class="bi bi-unlock-fill"></i> No Encryption Key Loaded</strong>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">Stored Files</h2>
    <div>
      <a class="btn btn-primary btn-sm" href="{{ url_for('upload') }}">
        <i class="bi bi-upload"></i> Upload New
      </a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('inbox') }}">
        <i class="bi bi-inbox"></i> Inbox
      </a>
    </div>
  </div>

  {% if files %}
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Original Name</th>
            <th>Mime</th>
            <th>Size (bytes)</th>
            <th>Uploaded</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for f in files %}
          <tr>
            <td>{{ f[0] }}</td>
            <td class="fw-semibold">{{ f[1] }}</td>
            <td>{{ f[3] }}</td>
            <td>{{ f[4] }}</td>
            <td>{{ f[5] }}</td>
            <td class="text-center">

              {% if f[3] and f[3].startswith('image/') %}
              <a class="btn btn-sm btn-outline-success" 
                 href="{{ url_for('preview', file_id=f[0]) }}" 
                 target="_blank">
                Preview
              </a>
              {% endif %}

              <a class="btn btn-sm btn-outline-primary"
                 href="{{ url_for('download', file_id=f[0]) }}">
                Download
              </a>

              <form method="post"
                    action="{{ url_for('delete', file_id=f[0]) }}"
                    class="d-inline"
                    onsubmit="return confirm('Are you sure you want to delete this file?');">
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  Delete
                </button>
              </form>

              {% if current_user and (current_user.id == f[6] or current_user.role == 'admin') %}
              <details class="d-inline-block ms-2">
                <summary class="btn btn-sm btn-outline-secondary">
                  Share
                </summary>
                <div class="mt-2 p-2 border rounded bg-light">
                  <form method="post" action="{{ url_for('share_file', file_id=f[0]) }}">
                    <input class="form-control form-control-sm mb-2"
                           name="username"
                           placeholder="Username"
                           required>

                    <input class="form-control form-control-sm mb-2"
                           name="message"
                           placeholder="Optional message">

                    <button class="btn btn-sm btn-primary w-100" type="submit">
                      Send
                    </button>
                  </form>
                </div>
              </details>
              {% endif %}

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
    <div class="alert alert-info">
      No files uploaded yet.
    </div>
  {% endif %}

</div>

{% endblock %}

